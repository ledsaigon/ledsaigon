CKEDITOR.dialog.add('googlemapsMarker',function(editor){var numbering=function(id){return id+CKEDITOR.tools.getNextNumber()},markerIcon=numbering('markerIcon'),GMapTexts=numbering('GMapTexts'),markerImage;function getIcon(color){return'//maps.gstatic.com/mapfiles/ms/micons/'+color+'-dot.png'}function getColor(src){return src.match(/\/micons\/(.*)-dot/)[1]}return{title:editor.lang.googlemaps.markerProperties,minWidth:310,minHeight:240,buttons:[{type:'button',id:'deleteMarker',label:editor.lang.googlemaps.deleteMarker,onClick:function(evt){var dialog=evt.sender.getDialog();dialog.onRemoveMarker();dialog.hide()}},CKEDITOR.dialog.okButton,CKEDITOR.dialog.cancelButton],onLoad:function(evt){this.setValues=function(data){this.definition.setValues.call(this,data)};this.getValues=function(){return this.definition.getValues.call(this)};this.setValues({title:'tooltip',maxWidth:200,text:'Write your text',color:'red'});this.destroy=CKEDITOR.tools.override(this.destroy,function(original){return function(){CKEDITOR.instances[GMapTexts].destroy();original.call(this)}})},setValues:function(data){var control=this.getContentElement('Info','txtTooltip');control.setValue(data.title);control.setInitValue();control=this.getContentElement('Info','txtWidth');control.setValue(data.maxWidth);control.setInitValue();var instance=CKEDITOR.instances[GMapTexts];if(instance)instance.setData(data.text);else document.getElementById(GMapTexts).value=data.text;markerImage=getIcon(data.color);document.getElementById(markerIcon).src=markerImage},getValues:function(){return{title:this.getValueOf('Info','txtTooltip'),maxWidth:this.getValueOf('Info','txtWidth'),text:CKEDITOR.instances[GMapTexts].getData(),color:getColor(markerImage)}},contents:[{id:'Info',elements:[{type:'hbox',widths:['160px','68px; padding-right:2px','30px','60px','10px'],children:[{id:'txtTooltip',type:'text',widths:['70px','90px'],width:'80px',labelLayout:'horizontal',label:editor.lang.googlemaps.tooltip},{id:'txtWidth',type:'text',widths:['40px','24px'],width:'24px',labelLayout:'horizontal',label:editor.lang.googlemaps.width},{type:'html',html:'<div>px</div>'},{type:'html',onClick:function(evt){var target=evt.data.getTarget(),targetName=target.getName();if(targetName=='img'){editor.openNestedDialog('googlemapsIcons',function(dialog){dialog.initialSrc=markerImage;dialog.onSelect=function(src){markerImage=src;document.getElementById(markerIcon).src=markerImage}},null)}},html:'<div><label style="float:left">'+editor.lang.googlemaps.markerIcon+'</label><img id="'+markerIcon+'" class="cke_hand"></div>'},{type:'html',html:'<div> </div>'}]},{type:'html',onLoad:function(){var removePlugins="elementspath,resize,googlemaps";var removed=editor.config.removePlugins;if(removed)removePlugins+=","+removed;var config=CKEDITOR.tools.clone(editor.config);config.customConfig='';config.width="300px";config.height=140;config.toolbar=[["Bold","Italic","Link","Image"],["Undo","Redo"]];config.removePlugins=removePlugins;config.toolbarCanCollapse=false;CKEDITOR.replace(GMapTexts,config)},html:'<textarea id="'+GMapTexts+'"></textarea>'}]}]}});